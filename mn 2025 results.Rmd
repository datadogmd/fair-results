---
title: "MN 2025 Results"
author: "MaDuSa"
date: "2025-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r libraries}
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(pdftools))
suppressPackageStartupMessages(library(stringr))
```


```{r constants}
resultsPageHeadTail <- c("MINNESOTA STATE FAIR", "Page")
creativeActivity <- "Creative Activities"
em_dash <- " \u2014 "
lower_doublequote <- "\u201E"
winnerListSeparator = " {3,}" # split by 3 or more blank spaces
stateSeparator <- ", "
eol <- "\n"
classCode <- NULL
classDescriptor1 <- NULL
entryCountFlag <- " Entries in "
classTypeList <- c("class", "lot")
classCount <- NULL
classDescriptor2 <- NULL
entryCount <- NULL
entryRank <- NULL
entryName <- NULL # firstname lastname
entryGuild <- NULL
entryCity <- NULL # city, state abbreviation
entryState <- NULL
honerableMention <- "HM"
runnerUp <- "runner-up"

```


```{r load pdf}

#pdfPath <- "D:/data/state fair/mn"
pdfPath <- "C:/Users/mdusa/Documents/mdusaire50/analytics/data/mn"
fileList <- dir(pdfPath)
wholePage <- pdftools::pdf_text(paste(pdfPath, fileList[4], sep = "/"))

```

pageLines is approximately twice as large as wholePage

Some classes, such as Sweepstakes, may be missing "Entries in class:". I add and entry for these rows.

Get class info

The class info contains:
* class code (which may be different every year)
* class name
* class qualifiers
* class entries count

```{r functions}

insertMissingDescriptor <- function(pageLines, missingDescriptorIndex) {
  
  arrayLength <- length(pageLines)
  nShifts <- length(missingDescriptorIndex)
  
  if (nShifts > 0) {
    for (i in 1:nShifts) {
      pageLines[(missingDescriptorIndex[i] + 1):(arrayLength + 1)] <-
        pageLines[missingDescriptorIndex[i]:arrayLength]
      pageLines[missingDescriptorIndex[i]] <- "None"
      
      # Update target rows to account for new row inserted above.
      missingDescriptorIndex[i + 1] <- missingDescriptorIndex[i + 1] + i
      
      # Update arrayLength to account for newly inserted row.
      arrayLength <- length(pageLines)
    }
  }
  return(pageLines)
}


multiLineMerge <- function(pageLines, targetLines) {
  
  nTargetLines <- length(targetLines)
  if (nTargetLines != 0) {
    linesToMerge <- targetLines - 1
    
    for (i in 1:nTargetLines) {
      insertClassDescriptorHere <- max(unlist(gregexpr(entryCountFlag, pageLines[targetLines[i] - 1])
      )
      ) - 1
      pageLines[targetLines[i] - 1] <- 
        paste0(substr(pageLines[targetLines[i] - 1], 1,
                      insertClassDescriptorHere), " ",
               pageLines[targetLines[i]], " ",
               substr(pageLines[targetLines[i] - 1],
                      (insertClassDescriptorHere + 1),
                      nchar(pageLines[targetLines[i] - 1])
               )
        )
    }
    
    # Removed now redundant lines in multi-line descriptors
    pageLines <- pageLines[-targetLines]
  }
  return(pageLines)
}



getFirstWinners <- function(pageLines) {
  
  # Get indices for first position in each list of winners
  
  winnerLines <- which(grepl("^[0-9] {3}", pageLines))
  winnerLinesDiff <- diff(c(0,winnerLines))
  
  # pageLines[winnerLines[winnerLinesDiff != 1]]
  
  return(winnerLines[winnerLinesDiff != 1])
}



regex_between <- function(start_str, end_str, page_ln) {
  
  # Construct the regular expression
  # The '.*?' is a non-greedy match for any characters between the two patterns
  regex_pattern <- paste0(start_str, "(.*?)\\", end_str)
  
  # Find the starting and ending positions of the match
  match_info <- regexpr(regex_pattern, page_ln, perl = TRUE)
  extracted_string <- substr(page_line, 
                             attr(match_info, "capture.start")[1], 
                             attr(match_info, "capture.start")[1] + attr(match_info, "capture.length")[1] - 1)
  extracted_string <- trimws(extracted_string, which = "both")
  return(extracted_string)
} 


```


```{r get year remove head and tail}

pageLines <- unlist(strsplit(wholePage, "\n")) # using base-R
lengthPageLines <- length(pageLines)

# Remove leading blanks

# pageLines <- trimws(pageLines, which = "left")

# Identify head and tail rows

pageHeadIndex <- which(grepl(resultsPageHeadTail[1], pageLines))
pageTailIndex <- which(grepl("\\d{1,2}:\\d{2}:\\d{2}", pageLines))

year <- strsplit(trimws(pageLines[pageHeadIndex[1]], which = "left"), " ")[[1]][1]
activity <- strsplit(pageLines[pageHeadIndex[1] + 1], "[:-]")[[1]][2]

# Remove head and tail rows

pageLines <- pageLines[-sort(c(pageHeadIndex, pageHeadIndex + 1, pageTailIndex))]
lengthPageLines <- length(pageLines)

```


```{r typo cleanup}
# Replace repeat commas with single comma
pageLines <- gsub(lower_doublequote, ",",pageLines)

```


```{r get class type}

# Detect classType

classType <- pageLines[grep(entryCountFlag, pageLines)[1]] %>%
  strsplit(split = entryCountFlag)
classType <- str_trim(strsplit(classType[[1]][2], ":")[[1]][1], side = "both")
class_type_title <- str_to_title(classType) # If you don't capitalize, then words like "Cloth" trigger unwanted actions.

classDelimiter <- paste0(class_type_title, ".*", "\u2014")

```


```{r add entry count tag where missing}

classRows <- grepl(classDelimiter, pageLines) # Row numbers for Class information
classRowIndex <- which(classRows)
# length(classRowIndex)

missingEntryCount <- is.na(str_match(pageLines[classRows], entryCountFlag))

# Rows with no "Entries in" flag

noClassEntryCount <- pageLines[classRows][missingEntryCount]

pageLines[classRows][missingEntryCount] <- paste(noClassEntryCount, " ", entryCountFlag, " ",
                                                 classType, ": ", "1", sep = "")

```


```{r merge split line descriptions}

# Merge split lines.  It appears that split line class descriptions are non-empty lines with less than 2 blanks at the beginning of the string.

blankLines <- pageLines == ""
multiLines <- !grepl("^[[:blank:]]{2}", pageLines) & !classRows & !blankLines

# The lines immediately following the Class descriptor with one or fewer blanks is likely part of a multi-line descriptor. A blank line immediately following the Class descriptor usually corresponds to a missing secondary class descriptor.  These are considered later.

multiLineRow <- (which(multiLines) - 1) %in% classRowIndex

targetLines <- which(multiLines)[multiLineRow]

pageLines <- multiLineMerge(pageLines, targetLines)

classRows <- grepl(classDelimiter, pageLines) # Row numbers for Class information
classRowIndex <- which(classRows)

```


```{r add missing secondary class descriptor}

# Find empty lines or winner rows immediately following a Class row.

secondDescriptor <- rep(FALSE, length(pageLines))
secondDescriptor[which(classRows) + 1] <- TRUE

blankLines <- pageLines == ""

winnerRows <- grepl("^[0-9] {3}", trimws(pageLines, which = "left"))

# Blank lines and winner rows immediately following the Class row should be replaced with the class identifier:  None

missingDescriptor <- (winnerRows | blankLines) & secondDescriptor

pageLines <- insertMissingDescriptor(pageLines, which(missingDescriptor))

# Remove leading blanks from all lines.

pageLines <- trimws(pageLines, which = "left")

```



```{r remove blank lines and split winner rows}
# Remove blank lines
blankLines <- pageLines == ""
pageLines <- pageLines[-which(blankLines)]

# Add comma delimiters to winner rows
winnerRows <- grepl("^[0-9]", pageLines)

pageLines[winnerRows] <- gsub(" {3,}", ",", pageLines[winnerRows])

```


```{r insert extra commas in winner rows}

# Number of commas in the winner rows is equivalent to the number of columns in the row.  Most will have 3 commas: Rank, Firstname Lastname, City Name, State Abbreviation.  Some may have multiple participants per line, or a guild name.  Find the maximum for the document and add the n - l + 1  columns before the City Name.

winnerRows <- grepl("^[0-9]", pageLines)
winnerRowsIndex <- which(winnerRows)
comma_count <- str_count(pageLines[winnerRows], ",")
comma_index <- gregexpr(",", pageLines[winnerRows])
comma_list <- lapply(comma_index,c)
winner_count <- length(which(winnerRows))
n <- 6 #number of commas winner rows should contain
for (i in 1:winner_count) {
  l <- comma_count[i]
  comma_idx <- comma_list[[i]][l - 1]
  str_sub(pageLines[winnerRowsIndex[i]], comma_idx, comma_idx) <- strrep(",", (n - l + 1))
}

# pageLines[winnerRowsIndex]

```


```{r transform into a long dataframe}

# Associate each class with the secondary descriptor and a list of winners

class_rows_grepl <- grepl(classDelimiter, pageLines) # Row numbers for Class information

class_rows <- which(class_rows_grepl)
n_class_rows <- length(class_rows)
class_group_steps <- diff(class_rows) - 1
class_group_steps[n_class_rows] <- length(class_rows_grepl) - class_rows[n_class_rows]

winners <- NULL
for (i in 1:n_class_rows) {
  cr_start <- class_rows[i]
  cr_end <- cr_start + class_group_steps[i]
  cr_seq <- seq(cr_start, cr_end)
  page_line <- pageLines[cr_seq[1]]
  # First line of the Class group contains the class code, class description (long) and entrant count.
  start_string <- class_type_title
  end_string <- em_dash  
  class_code <- regex_between(start_string, end_string, page_line)
  start_string <- em_dash
  end_string <- entryCountFlag
  class_description_long <- regex_between(start_string, end_string, page_line)
  class_count <- strsplit(page_line, ": ")[[1]][2] |>
    trimws(, which = "both")

  # Second line contains a shorter class descriptor
  class_description_short <- trimws(pageLines[cr_seq[2]], which = "both")

  # The remaining lines are the winners list

  for (j in 3:length(cr_seq)) {
    winner_line_split <- strsplit(pageLines[cr_seq[j]], ",")
    position <- winner_line_split[[1]][1]
    full_name <- winner_line_split[[1]][2]
    group1 <- winner_line_split[[1]][3]
    group2 <- winner_line_split[[1]][4]
    item1 <- winner_line_split[[1]][5]
    city <- winner_line_split[[1]][6]
    state <- trimws(winner_line_split[[1]][7], which = "both")

    new_winners <- data.frame(position = position,
                              fullname = full_name,
                              group1 = group1,
                              group2 = group2,
                              item1 = item1,
                              city = city,
                              state = state,
                              classcode = class_code,
                              longdescription = class_description_long,
                              shortdescription = class_description_short,
                              count = class_count,
                              activity = activity,
                              year = year)
    
    if (is.null(winners)) {
      winners <- new_winners
    } else {
      winners <- rbind(winners, new_winners)
    }
  }
}

```


```{r}


```
